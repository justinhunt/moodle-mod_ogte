define(["jquery","core/log","core/str","mod_ogte/utils"],(function($,log,str,utils){log.debug("OGTE Article: initialising");var hiddenTextBox=$("input[name='text']"),hiddenListIdBox=$("input[name='listid']"),hiddenLevelIdBox=$("input[name='levelid']"),hiddenIgnoresBox=$("input[name='ignores']"),hiddenJSONRatingBox=($("input[name='title']"),$("input[name='jsonrating']")),passagebox=$("#the_al_passage"),levelstats=$("#the_al_levelstats"),articlestats=$("#the_al_articlestats"),themessage=$("#the_al_message"),thebutton=$("#the_al_button"),listselect=$("#the_listselect"),levelselect=$("#the_levelselect"),addtoIgnoreButton=$("#the_addtoignore"),ignorelist=$("#the_ignorelist"),statusmessage=$("#the_al_status_message"),app={strings:{},opts:{},init:function(props){log.debug("initializing article leveler");var theid="#"+props.optsid,configcontrol=$(theid).get(0);if(configcontrol){this.opts=JSON.parse(configcontrol.value),$(theid).remove(),this.init_strings(),this.registerEvents();var jsonrating_string=hiddenJSONRatingBox.val();if(log.debug("is json?"),this.isJSON(jsonrating_string)){log.debug("yes json");var jsonrating=JSON.parse(jsonrating_string);log.debug("is level stats"),jsonrating.hasOwnProperty("passage")&&(log.debug("yes level stats"),this.updateAllFromJSONRating(jsonrating))}var listid=hiddenListIdBox.val(),levelid=hiddenLevelIdBox.val();""!==listid&&""!==levelid&&(listselect.val(listid),levelselect.val(levelid));var ignores=hiddenIgnoresBox.val();""!==ignores&&ignorelist.val(ignores)}else log.debug("No config found on page. Giving up.")},init_strings:function(){var that=this,strs=["alreadyignored","selecttoignore","doignore","entersomething","texttoolong5000"];for(var key in strs){var thestring=strs[key];str.get_string(thestring,"mod_ogte").done((function(s){that.strings[thestring]=s}))}str.get_strings([{key:"alreadyignored",component:"mod_ogte"},{key:"selecttoignore",component:"mod_ogte"},{key:"doignore",component:"mod_ogte"},{key:"entersomething",component:"mod_ogte"},{key:"texttoolong5000",component:"mod_ogte"}]).done((function(s){var i=0;that.strings.alreadyignored=s[i++],that.strings.selecttoignore=s[i++],that.strings.doignore=s[i++],that.strings.entersomething=s[i++],that.strings.texttoolong5000=s[i++]}))},updateAllFromJSONRating:function(jsonrating){log.debug("updateAllFromJSONRating"),themessage.text(""),passagebox.html(jsonrating.passage);var articleStatsTable=utils.analyzeText(jsonrating.passage);articlestats.html(articleStatsTable),articlestats.show();var levelStatsTable=utils.levelStats(jsonrating);levelstats.html(levelStatsTable),levelstats.show()},isJSON:function(str){try{return JSON.parse(str),!0}catch(e){return!1}},getSelectedText:function(){var selectedText="";return window.getSelection?selectedText=window.getSelection().toString():document.selection&&"Control"!==document.selection.type&&(selectedText=document.selection.createRange().text),selectedText},updateLevelDropdown:function(){const selectedList=listselect.val();log.debug("selected list: "+selectedList),levelselect.empty(),app.opts.listlevels[selectedList].forEach((function(option){levelselect.append($('<option value="'+option.key+'">'+option.label+"</option>"))})),levelselect.prop("selectedIndex",0),hiddenListIdBox.val(selectedList),hiddenLevelIdBox.val(levelselect.val())},registerEvents:function(){var that=this;addtoIgnoreButton.on("click",(function(e){var word=utils.getSelectedWord();if(""!==word){var newignorelist=ignorelist.val()+" "+word;ignorelist.val(newignorelist),hiddenIgnoresBox.val(newignorelist),statusmessage.text(app.strings.alreadyignored+word),addtoIgnoreButton.hide()}})),passagebox.on("paste",(function(e){e.preventDefault();var text=(e.originalEvent||e).clipboardData.getData("text/plain");$(this).text(text),hiddenTextBox.val($(this).text())})),passagebox.on("input",(function(e){var thetext=$(this)[0].innerText;hiddenTextBox.val(thetext)})),passagebox.on("mouseup",(function(e){var selectedText=that.getSelectedText();if(""===selectedText)return statusmessage.text(app.strings.selecttoignore),void addtoIgnoreButton.hide();var word=selectedText.trim();return word.includes(" ")?(statusmessage.text(app.strings.selecttoignore),void addtoIgnoreButton.hide()):ignorelist.val().toLowerCase().includes(word.toLowerCase())?(statusmessage.text(app.strings.alreadyignored+word),void addtoIgnoreButton.hide()):(statusmessage.text(""),addtoIgnoreButton.text(app.strings.doignore+word),addtoIgnoreButton.data("ignore",word),void addtoIgnoreButton.show())})),ignorelist.on("change",(function(e){hiddenIgnoresBox.val($(this).val())})),listselect.on("change",(function(e){var listid=$(this).val();hiddenListIdBox.val(listid),that.updateLevelDropdown()})),levelselect.on("change",(function(e){var levelid=$(this).val();hiddenLevelIdBox.val(levelid)})),thebutton.on("click",(function(){themessage.html('<i class="fa fa-spinner fa-spin fa-sm"></i>');var thepassage=passagebox[0].innerText;if(thepassage&&""!==thepassage.trim())if(thepassage.length>5e3)themessage.text(app.strings.texttoolong5000);else{var ignore=ignorelist.val(),listid=listselect.val(),listlevel=levelselect.val(),ogteid=app.opts.ogteid;utils.levelPassage(thepassage,ignore,listid,listlevel,ogteid).then((function(ajaxresult){var theresponse=JSON.parse(ajaxresult);theresponse?(hiddenJSONRatingBox.val(ajaxresult),that.updateAllFromJSONRating(theresponse)):log.debug("ajax call to level coverage failed")}))}else themessage.text(app.strings.entersomething)}))}};return app}));

//# sourceMappingURL=articleleveler.min.js.map