define("mod_ogte/articleleveler",["jquery","core/log","core/notification","core/str","core/templates","mod_ogte/utils","mod_ogte/clipboardhelper","mod_ogte/popoverhelper"],(function($,log,notification,str,templates,utils,clipboardhelper,popoverhelper){log.debug("OGTE Article: initialising");var hiddenTextBox=$("input[name='text']"),hiddenListIdBox=$("input[name='listid']"),hiddenLevelIdBox=$("input[name='levelid']"),hiddenIgnoresBox=$("input[name='ignores']"),hiddenJSONRatingBox=($("input[name='title']"),$("input[name='jsonrating']")),passagebox=$("#the_al_passage"),levelstats=$("#the_al_levelstats"),articlestats=$("#the_al_articlestats"),themessage=$("#the_al_message"),thebutton=$("#the_al_button"),listselect=$("#the_listselect"),levelselect=$("#the_levelselect"),addtoIgnoreButton=$("#the_addtoignore"),downloadButton=$(".ogte_downloadbutton"),sendToEditorButton=$(".ogte_ar_sendtoeditor_button"),ignorelist=$("#the_ignorelist"),statusmessage=$("#the_al_status_message"),outoflistwords_block=$("#the_outoflistwords"),outoflevelwords_block=$("#the_outoflevelwords"),ignoredwords_block=$("#the_ignoredwords"),outoflevelfreq_block=$("#the_outoflevelfreq"),punctuationRegex=/[!"#$%&'()*+,-./:;<=>?@[\]^_`{|}~]+$/,app={strings:{},opts:{},init:function(props){log.debug("initializing article leveler");var theid="#"+props.optsid,configcontrol=$(theid).get(0);if(configcontrol){this.opts=JSON.parse(configcontrol.value),$(theid).remove(),this.init_strings(),this.registerEvents(),clipboardhelper.init({});var jsonrating_string=hiddenJSONRatingBox.val();if(log.debug("is json?"),this.isJSON(jsonrating_string)){log.debug("yes json");var jsonrating=JSON.parse(jsonrating_string);log.debug("is level stats"),jsonrating.hasOwnProperty("passage")&&(log.debug("yes level stats"),this.updateAllFromJSONRating(jsonrating))}var listid=hiddenListIdBox.val(),levelid=hiddenLevelIdBox.val();if(""!==listid&&""!==levelid)listselect.val(listid),levelselect.val(levelid);else{listid=listselect.val();this.updateLevelDropdown(listid)}var ignores=hiddenIgnoresBox.val();""!==ignores&&ignorelist.val(ignores),popoverhelper.init(),popoverhelper.onIgnore=this.doIgnore}else log.debug("No config found on page. Giving up.")},init_strings:function(){var that=this,strs=["alreadyignored","selecttoignore","doignore","entersomething","texttoolong5000","ignored","outoflist","outoflevel","outoflevelfreq"];for(var key in strs){var thestring=strs[key];str.get_string(thestring,"mod_ogte").done((function(s){that.strings[thestring]=s}))}that.strings.alreadyignored="Already Ignored",that.strings.selecttoignore="Select to Ignore",that.strings.doignore="Ignore",that.strings.entersomething="Enter something",that.strings.texttoolong5000="Text too long (5000 characters max)",that.strings.ignored="Ignored",that.strings.outoflist="Out of List",that.strings.outoflevel="Out of Level",that.strings.outoflevelfreq="% Out of Level",str.get_strings([{key:"alreadyignored",component:"mod_ogte"},{key:"selecttoignore",component:"mod_ogte"},{key:"doignore",component:"mod_ogte"},{key:"entersomething",component:"mod_ogte"},{key:"texttoolong5000",component:"mod_ogte"},{key:"ignored",component:"mod_ogte"},{key:"outoflist",component:"mod_ogte"},{key:"outoflevel",component:"mod_ogte"},{key:"outoflevelfreq",component:"mod_ogte"}]).done((function(s){var i=0;that.strings.alreadyignored=s[i++],that.strings.selecttoignore=s[i++],that.strings.doignore=s[i++],that.strings.entersomething=s[i++],that.strings.texttoolong5000=s[i++],that.strings.ignored=s[i++],that.strings.outoflist=s[i++],that.strings.outoflevel=s[i++],that.strings.outoflevelfreq=s[i++]}))},updateAllFromJSONRating:function(jsonrating){log.debug("updateAllFromJSONRating"),themessage.text(""),passagebox.html(jsonrating.passage),jsonrating.listname=app.opts.listlevels[jsonrating.listid][jsonrating.levelid].listname,jsonrating.levelname=app.opts.listlevels[jsonrating.listid][jsonrating.levelid].label,templates.render("mod_ogte/levelstatstable",jsonrating).done(function(html,js){levelstats.fadeOut("fast",function(){templates.replaceNodeContents(levelstats,html,js),levelstats.fadeIn("fast")}.bind(this))}.bind(this)).fail(notification.exception);var textStatsData=utils.analyzeText(jsonrating.passage);templates.render("mod_ogte/textstatstable",textStatsData).done(function(html,js){articlestats.fadeOut("fast",function(){templates.replaceNodeContents(articlestats,html,js),articlestats.fadeIn("fast")}.bind(this))}.bind(this)).fail(notification.exception);var ignoredAndOutOfData=utils.analyzeOutListLevelsIgnored(jsonrating.passage);outoflistwords_block.show(),templates.render("mod_ogte/block_uncovered",{words:ignoredAndOutOfData.outoflist,haswords:ignoredAndOutOfData.outoflist.length>0,haslevels:!1,title:this.strings.outoflist}).done(function(html,js){outoflistwords_block.fadeOut("fast",function(){templates.replaceNodeContents(outoflistwords_block,html,js),outoflistwords_block.fadeIn("fast")}.bind(this))}.bind(this)).fail(notification.exception),outoflevelwords_block.show(),templates.render("mod_ogte/block_uncovered",{words:ignoredAndOutOfData.outoflevel,haswords:ignoredAndOutOfData.outoflevel.length>0,haslevels:!0,title:this.strings.outoflevel}).done(function(html,js){outoflevelwords_block.fadeOut("fast",function(){templates.replaceNodeContents(outoflevelwords_block,html,js),outoflevelwords_block.fadeIn("fast")}.bind(this))}.bind(this)).fail(notification.exception),ignoredwords_block.show(),templates.render("mod_ogte/block_uncovered",{words:ignoredAndOutOfData.ignored,haswords:ignoredAndOutOfData.ignored.length>0,haslevels:!1,title:this.strings.ignored}).done(function(html,js){ignoredwords_block.fadeOut("fast",function(){templates.replaceNodeContents(ignoredwords_block,html,js),ignoredwords_block.fadeIn("fast")}.bind(this))}.bind(this)).fail(notification.exception);var outOfLevelFreqData=utils.calc_outoflevel_frequencies(jsonrating.passage);outoflevelfreq_block.show(),templates.render("mod_ogte/block_outoflevelfreq",{levels:outOfLevelFreqData,haslevels:outOfLevelFreqData.length>0,title:this.strings.outoflevelfreq}).done(function(html,js){outoflevelfreq_block.fadeOut("fast",function(){templates.replaceNodeContents(outoflevelfreq_block,html,js),outoflevelfreq_block.fadeIn("fast")}.bind(this))}.bind(this)).fail(notification.exception)},isJSON:function(str){try{return JSON.parse(str),!0}catch(e){return!1}},getSelectedText:function(){var selectedText="";return window.getSelection?selectedText=window.getSelection().toString():document.selection&&"Control"!==document.selection.type&&(selectedText=document.selection.createRange().text),selectedText},updateLevelDropdown:function(){const selectedList=listselect.val();log.debug("selected list: "+selectedList),levelselect.empty(),app.opts.listlevels[selectedList].forEach((function(option){levelselect.append($('<option value="'+option.key+'">'+option.label+"</option>"))})),levelselect.prop("selectedIndex",0),hiddenListIdBox.val(selectedList),hiddenLevelIdBox.val(levelselect.val())},setStatusMessage:function(message){statusmessage.text(message),setTimeout((function(){statusmessage.fadeOut()}),2e3)},doPopover:function(that,e){if("SPAN"===e.target.tagName||"DIV"===e.target.tagName)var selectedText=$(that).text();else if("INPUT"===e.target.tagName||"TEXTAREA"===e.target.tagName)selectedText=that.getSelectedText();if(""!==selectedText){var word=selectedText.trim();if(word.includes(" "))addtoIgnoreButton.hide();else{word=word.replace(punctuationRegex,"");var ignoring=ignorelist.val().toLowerCase().includes(word.toLowerCase());popoverhelper.doPopup(that,word,ignoring)}}},doIgnore:function(word,ignore){var ignores=ignorelist.val(),ignoring=ignores.toLowerCase().includes(word.toLowerCase());if(ignore){if(ignoring)return void log.debug("already ignoring: "+word);log.debug("ignoring: "+word);var newignorelist=ignores+" "+word;ignorelist.val(newignorelist),hiddenIgnoresBox.val(newignorelist);var wordRegex=new RegExp("\\b"+word+"\\b","gi");passagebox.find("span").filter((function(){return wordRegex.test($(this).text())})).addClass("mod_ogte_ignored"),thebutton.addClass("mod_ogte_refreshrequired")}else{if(!ignoring)return void log.debug("already unignoring: "+word);log.debug("unignoring: "+word);newignorelist=ignores.replace(word,"");ignorelist.val(newignorelist),hiddenIgnoresBox.val(newignorelist);wordRegex=new RegExp("\\b"+word+"\\b","gi");passagebox.find("span").filter((function(){return wordRegex.test($(this).text())})).removeClass("mod_ogte_ignored"),thebutton.addClass("mod_ogte_refreshrequired")}},registerEvents:function(){var that=this;addtoIgnoreButton.on("click",(function(e){var word=utils.getSelectedWord();if(""!==word){var newignorelist=ignorelist.val()+" "+word;ignorelist.val(newignorelist),hiddenIgnoresBox.val(newignorelist),app.setStatusMessage(app.strings.alreadyignored+word),addtoIgnoreButton.hide()}})),downloadButton.on("click",(function(e){var target_selector=$(this).attr("data-download-target"),text=$(target_selector).text(),filename="article.txt",filename_selector=$(this).attr("data-download-filename");""!==filename_selector&&void 0!==filename_selector&&(filename=(filename=$(filename_selector).val()+".txt").trim().replace(/ /g,"_")),utils.downloadTextContent(text,filename)})),sendToEditorButton.on("click",(function(){var target_selector=$(this).attr("data-send-target"),text=$(target_selector).val();passagebox.text(text),hiddenTextBox.val(text),thebutton.click(),$(".mod_ogte_tab-content .tab-pane").removeClass("active"),$(".mod_ogte_tab-content #articleleveler").addClass("active"),$(".mod_ogte_nav-pills .nav-link").removeClass("active"),$('.mod_ogte_nav-pills a[href="#articleleveler"]').addClass("active"),$("#articleleveler").tab("show")})),passagebox.on("paste",(function(e){e.preventDefault();var text=(e.originalEvent||e).clipboardData.getData("text/plain");$(this).text(text),hiddenTextBox.val($(this).text())})),passagebox.on("input",(function(e){var thetext=$(this)[0].innerText;hiddenTextBox.val(thetext)})),passagebox.on("click","span",(function(e){that.doPopover(this,e)})),ignorelist.on("change",(function(e){hiddenIgnoresBox.val($(this).val())})),listselect.on("change",(function(e){var listid=$(this).val();hiddenListIdBox.val(listid),that.updateLevelDropdown()})),levelselect.on("change",(function(e){var levelid=$(this).val();hiddenLevelIdBox.val(levelid)})),thebutton.on("click",(function(){themessage.html('<i class="fa fa-spinner fa-spin fa-sm"></i>');var thepassage=passagebox[0].innerText;if(thepassage&&""!==thepassage.trim())if(thepassage.length>5e4)themessage.text(app.strings.texttoolong5000);else{var ignore=ignorelist.val(),listid=listselect.val(),listlevel=levelselect.val(),ogteid=app.opts.ogteid;utils.levelPassage(thepassage,ignore,listid,listlevel,ogteid).then((function(ajaxresult){var theresponse=JSON.parse(ajaxresult);theresponse?(hiddenJSONRatingBox.val(ajaxresult),that.updateAllFromJSONRating(theresponse)):log.debug("ajax call to level coverage failed")}))}else themessage.text(app.strings.entersomething)}))}};return app}));

//# sourceMappingURL=articleleveler.min.js.map